
> hydrology-dashboard-backend@1.0.0 dev
> nodemon src/server.js

[33m[nodemon] 3.1.10[39m
[33m[nodemon] to restart at any time, enter `rs`[39m
[33m[nodemon] watching path(s): src\**\*[39m
[33m[nodemon] watching extensions: js,json[39m
[32m[nodemon] starting `node src/server.js`[39m
(node:21116) [MONGOOSE] Warning: Duplicate schema index on {"data_thoigian":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(Use `node --trace-warnings ...` to show where the warning was created)
(node:21116) [MONGOOSE] Warning: Duplicate schema index on {"data_thoigian":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:21116) [MONGOOSE] Warning: Duplicate schema index on {"data_thoigian":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
node:events:496
      throw er; // Unhandled 'error' event
      ^

Error: listen EADDRINUSE: address already in use :::1423
    at Server.setupListenHandle [as _listen2] (node:net:1939:16)
    at listenInCluster (node:net:1996:12)
    at Server.listen (node:net:2101:7)
    at Function.listen (C:\project-hydrology-dashboard\backend\node_modules\express\lib\application.js:635:24)
    at Object.<anonymous> (C:\project-hydrology-dashboard\backend\src\server.js:95:20)
    at Module._compile (node:internal/modules/cjs/loader:1730:14)
    at Object..js (node:internal/modules/cjs/loader:1895:10)
    at Module.load (node:internal/modules/cjs/loader:1465:32)
    at Function._load (node:internal/modules/cjs/loader:1282:12)
    at TracingChannel.traceSync (node:diagnostics_channel:322:14)
Emitted 'error' event on Server instance at:
    at emitErrorNT (node:net:1975:8)
    at process.processTicksAndRejections (node:internal/process/task_queues:90:21) {
  code: 'EADDRINUSE',
  errno: -4091,
  syscall: 'listen',
  address: '::',
  port: 1423
}

Node.js v22.15.0
[31m[nodemon] app crashed - waiting for file changes before starting...[39m
[32m[nodemon] restarting due to changes...[39m
[32m[nodemon] starting `node src/server.js`[39m
(node:22512) [MONGOOSE] Warning: Duplicate schema index on {"data_thoigian":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(Use `node --trace-warnings ...` to show where the warning was created)
(node:22512) [MONGOOSE] Warning: Duplicate schema index on {"data_thoigian":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:22512) [MONGOOSE] Warning: Duplicate schema index on {"data_thoigian":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
🚀 Server is running on port 1423
📡 API available at http://localhost:1423/api/v1
🏥 Health check: http://localhost:1423/api/v1/health
🌊 Real-time data: http://localhost:1423/api/v1/get-tide-data-from-now
🔄 Combined data: http://localhost:1423/api/v1/get-combined-tide-data
⏰ Khởi tạo Tide Data Scheduler...
🚀 Khởi tạo Tide Data Scheduler...
⏰ Lịch trình: 0 * * * * (mỗi 1 giờ GMT+7)
🔥 Method: Gọi trực tiếp fetchAllStationsData(force=true)
🚀 Sẽ fetch dữ liệu tide realy sau 10 giây...
✅ Tide Data Scheduler đã được khởi tạo thành công!
🏞️ Khởi tạo HoDauTieng Data Scheduler...
🚀 Khởi tạo HoDauTieng Data Scheduler...
⏰ Lịch trình: 0 * * * * (mỗi 1 tiếng GMT+7)
📍 Dữ liệu: Mực nước hồ, Lưu lượng nước, Lưu lượng xả
🔄 Retry config: 3 attempts, 30000ms timeout
🚀 Sẽ fetch dữ liệu Hồ Dầu Tiếng sau 10 giây...
✅ HoDauTieng Data Scheduler đã được khởi tạo thành công!
🌊 Khởi tạo Mekong Data Scheduler...
🚀 Khởi tạo Mekong Data Scheduler...
⏰ Lịch trình: 0 * * * * (mỗi 1 giờ GMT+7)
🌊 Dữ liệu: Mekong water level data
🔗 API: Sử dụng URL_API_MEKONG từ environment
🚀 Sẽ fetch dữ liệu Mekong sau 15 giây...
✅ Mekong Data Scheduler đã được khởi tạo thành công!
🏙️ Khởi tạo Binh Duong Data Scheduler...
Binh Duong scheduler initialized (every hour)
✅ Tất cả Schedulers đã được khởi tạo (Tide, Station Update, HoDauTieng, Mekong, Binh Duong)
MongoDB connected
📋 Đã tải 3 trạm từ database: [
  '4B413AEE-357A-4FFE-9AE8-591FCA84468C',
  '4EC7BBAF-44E7-4DFA-BAED-4FB1217FBDA8',
  'C6B0DB30-500A-4BF9-AA09-B2470E85BF45'
]
🎬 Fetch dữ liệu tide realy lần đầu với force=true...
🎬 Fetch dữ liệu Hồ Dầu Tiếng lần đầu...
🏞️ Bắt đầu fetch dữ liệu Hồ Dầu Tiếng...
⏰ Thời gian: 03:41:12 21/8/2025
📅 Khoảng thời gian fetch: 2025-8-18 3:41:12 đến 2025-8-21 3:41:12 (GMT+7)
📅 Tổng cộng: 3 ngày
📊 Đang fetch dữ liệu mực nước hồ...
📡 Making API call to: https://hodautieng.vn/jaxrs/QuanTracHoChua/getDataQuanTracTB (Attempt 1/3)
📋 Request payload: {
  "data": {
    "hc_uuid": "613bbcf5-212e-43c5-9ef8-69016787454f",
    "tents": "Mực nước hồ",
    "mats": "MUCNUOCHO",
    "tungay": "2025-8-18 3:41:12",
    "denngay": "2025-8-21 3:41:12",
    "namdulieu": "2025",
    "namht": 2025,
    "mact": "613bbcf5-212e-43c5-9ef8-69016787454f"
  }
}
📋 Đã tải 3 trạm từ database: [
  '4B413AEE-357A-4FFE-9AE8-591FCA84468C',
  '4EC7BBAF-44E7-4DFA-BAED-4FB1217FBDA8',
  'C6B0DB30-500A-4BF9-AA09-B2470E85BF45'
]
🕐 Bắt đầu lịch trình gọi API thủy triều thực tế...
⏰ Thời gian: 03:41:12 21/8/2025
🔥 Force mode: true
📡 Đang gọi API cho trạm: 4B413AEE-357A-4FFE-9AE8-591FCA84468C (force=true)
🔄 Force refresh cho trạm: 4B413AEE-357A-4FFE-9AE8-591FCA84468C
📡 Gọi API (lần 1): http://e15.thuyloivietnam.vn/wsHienTrangHoChua/ChartRiverMucNuoc?stationcode=4B413AEE-357A-4FFE-9AE8-591FCA84468C
[32m[nodemon] restarting due to changes...[39m
[32m[nodemon] starting `node src/server.js`[39m
(node:1584) [MONGOOSE] Warning: Duplicate schema index on {"data_thoigian":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(Use `node --trace-warnings ...` to show where the warning was created)
(node:1584) [MONGOOSE] Warning: Duplicate schema index on {"data_thoigian":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:1584) [MONGOOSE] Warning: Duplicate schema index on {"data_thoigian":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
node:events:496
      throw er; // Unhandled 'error' event
      ^

Error: listen EADDRINUSE: address already in use :::1423
    at Server.setupListenHandle [as _listen2] (node:net:1939:16)
    at listenInCluster (node:net:1996:12)
    at Server.listen (node:net:2101:7)
    at Function.listen (C:\project-hydrology-dashboard\backend\node_modules\express\lib\application.js:635:24)
    at Object.<anonymous> (C:\project-hydrology-dashboard\backend\src\server.js:95:20)
    at Module._compile (node:internal/modules/cjs/loader:1730:14)
    at Object..js (node:internal/modules/cjs/loader:1895:10)
    at Module.load (node:internal/modules/cjs/loader:1465:32)
    at Function._load (node:internal/modules/cjs/loader:1282:12)
    at TracingChannel.traceSync (node:diagnostics_channel:322:14)
Emitted 'error' event on Server instance at:
    at emitErrorNT (node:net:1975:8)
    at process.processTicksAndRejections (node:internal/process/task_queues:90:21) {
  code: 'EADDRINUSE',
  errno: -4091,
  syscall: 'listen',
  address: '::',
  port: 1423
}

Node.js v22.15.0
[31m[nodemon] app crashed - waiting for file changes before starting...[39m
[32m[nodemon] restarting due to changes...[39m
[32m[nodemon] starting `node src/server.js`[39m
(node:14600) [MONGOOSE] Warning: Duplicate schema index on {"data_thoigian":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(Use `node --trace-warnings ...` to show where the warning was created)
(node:14600) [MONGOOSE] Warning: Duplicate schema index on {"data_thoigian":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:14600) [MONGOOSE] Warning: Duplicate schema index on {"data_thoigian":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
🚀 Server is running on port 1423
📡 API available at http://localhost:1423/api/v1
🏥 Health check: http://localhost:1423/api/v1/health
🌊 Real-time data: http://localhost:1423/api/v1/get-tide-data-from-now
🔄 Combined data: http://localhost:1423/api/v1/get-combined-tide-data
⏰ Khởi tạo Tide Data Scheduler...
🚀 Khởi tạo Tide Data Scheduler...
⏰ Lịch trình: 0 * * * * (mỗi 1 giờ GMT+7)
🔥 Method: Gọi trực tiếp fetchAllStationsData(force=true)
🚀 Sẽ fetch dữ liệu tide realy sau 10 giây...
✅ Tide Data Scheduler đã được khởi tạo thành công!
🏞️ Khởi tạo HoDauTieng Data Scheduler...
🚀 Khởi tạo HoDauTieng Data Scheduler...
⏰ Lịch trình: 0 * * * * (mỗi 1 tiếng GMT+7)
📍 Dữ liệu: Mực nước hồ, Lưu lượng nước, Lưu lượng xả
🔄 Retry config: 3 attempts, 30000ms timeout
🚀 Sẽ fetch dữ liệu Hồ Dầu Tiếng sau 10 giây...
✅ HoDauTieng Data Scheduler đã được khởi tạo thành công!
🌊 Khởi tạo Mekong Data Scheduler...
🚀 Khởi tạo Mekong Data Scheduler...
⏰ Lịch trình: 0 * * * * (mỗi 1 giờ GMT+7)
🌊 Dữ liệu: Mekong water level data
🔗 API: Sử dụng URL_API_MEKONG từ environment
🚀 Sẽ fetch dữ liệu Mekong sau 15 giây...
✅ Mekong Data Scheduler đã được khởi tạo thành công!
🏙️ Khởi tạo Binh Duong Data Scheduler...
Binh Duong scheduler initialized (every hour)
✅ Tất cả Schedulers đã được khởi tạo (Tide, Station Update, HoDauTieng, Mekong, Binh Duong)
MongoDB connected
📋 Đã tải 3 trạm từ database: [
  '4B413AEE-357A-4FFE-9AE8-591FCA84468C',
  '4EC7BBAF-44E7-4DFA-BAED-4FB1217FBDA8',
  'C6B0DB30-500A-4BF9-AA09-B2470E85BF45'
]
[32m[nodemon] restarting due to changes...[39m
[32m[nodemon] starting `node src/server.js`[39m
(node:19384) [MONGOOSE] Warning: Duplicate schema index on {"data_thoigian":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(Use `node --trace-warnings ...` to show where the warning was created)
(node:19384) [MONGOOSE] Warning: Duplicate schema index on {"data_thoigian":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:19384) [MONGOOSE] Warning: Duplicate schema index on {"data_thoigian":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
node:events:496
      throw er; // Unhandled 'error' event
      ^

Error: listen EADDRINUSE: address already in use :::1423
    at Server.setupListenHandle [as _listen2] (node:net:1939:16)
    at listenInCluster (node:net:1996:12)
    at Server.listen (node:net:2101:7)
    at Function.listen (C:\project-hydrology-dashboard\backend\node_modules\express\lib\application.js:635:24)
    at Object.<anonymous> (C:\project-hydrology-dashboard\backend\src\server.js:95:20)
    at Module._compile (node:internal/modules/cjs/loader:1730:14)
    at Object..js (node:internal/modules/cjs/loader:1895:10)
    at Module.load (node:internal/modules/cjs/loader:1465:32)
    at Function._load (node:internal/modules/cjs/loader:1282:12)
    at TracingChannel.traceSync (node:diagnostics_channel:322:14)
Emitted 'error' event on Server instance at:
    at emitErrorNT (node:net:1975:8)
    at process.processTicksAndRejections (node:internal/process/task_queues:90:21) {
  code: 'EADDRINUSE',
  errno: -4091,
  syscall: 'listen',
  address: '::',
  port: 1423
}

Node.js v22.15.0
[31m[nodemon] app crashed - waiting for file changes before starting...[39m
[32m[nodemon] restarting due to changes...[39m
[32m[nodemon] starting `node src/server.js`[39m
(node:17244) [MONGOOSE] Warning: Duplicate schema index on {"data_thoigian":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(Use `node --trace-warnings ...` to show where the warning was created)
(node:17244) [MONGOOSE] Warning: Duplicate schema index on {"data_thoigian":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:17244) [MONGOOSE] Warning: Duplicate schema index on {"data_thoigian":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
🚀 Server is running on port 1423
📡 API available at http://localhost:1423/api/v1
🏥 Health check: http://localhost:1423/api/v1/health
🌊 Real-time data: http://localhost:1423/api/v1/get-tide-data-from-now
🔄 Combined data: http://localhost:1423/api/v1/get-combined-tide-data
⏰ Khởi tạo Tide Data Scheduler...
🚀 Khởi tạo Tide Data Scheduler...
⏰ Lịch trình: 0 * * * * (mỗi 1 giờ GMT+7)
🔥 Method: Gọi trực tiếp fetchAllStationsData(force=true)
🚀 Sẽ fetch dữ liệu tide realy sau 10 giây...
✅ Tide Data Scheduler đã được khởi tạo thành công!
🏞️ Khởi tạo HoDauTieng Data Scheduler...
🚀 Khởi tạo HoDauTieng Data Scheduler...
⏰ Lịch trình: 0 * * * * (mỗi 1 tiếng GMT+7)
📍 Dữ liệu: Mực nước hồ, Lưu lượng nước, Lưu lượng xả
🔄 Retry config: 3 attempts, 30000ms timeout
🚀 Sẽ fetch dữ liệu Hồ Dầu Tiếng sau 10 giây...
✅ HoDauTieng Data Scheduler đã được khởi tạo thành công!
🌊 Khởi tạo Mekong Data Scheduler...
🚀 Khởi tạo Mekong Data Scheduler...
⏰ Lịch trình: 0 * * * * (mỗi 1 giờ GMT+7)
🌊 Dữ liệu: Mekong water level data
🔗 API: Sử dụng URL_API_MEKONG từ environment
🚀 Sẽ fetch dữ liệu Mekong sau 15 giây...
✅ Mekong Data Scheduler đã được khởi tạo thành công!
🏙️ Khởi tạo Binh Duong Data Scheduler...
Binh Duong scheduler initialized (every hour)
✅ Tất cả Schedulers đã được khởi tạo (Tide, Station Update, HoDauTieng, Mekong, Binh Duong)
MongoDB connected
📋 Đã tải 3 trạm từ database: [
  '4B413AEE-357A-4FFE-9AE8-591FCA84468C',
  '4EC7BBAF-44E7-4DFA-BAED-4FB1217FBDA8',
  'C6B0DB30-500A-4BF9-AA09-B2470E85BF45'
]
🎬 Fetch dữ liệu tide realy lần đầu với force=true...
🎬 Fetch dữ liệu Hồ Dầu Tiếng lần đầu...
🏞️ Bắt đầu fetch dữ liệu Hồ Dầu Tiếng...
⏰ Thời gian: 03:42:21 21/8/2025
📅 Khoảng thời gian fetch: 2025-8-18 3:42:21 đến 2025-8-21 3:42:21 (GMT+7)
📅 Tổng cộng: 3 ngày
📊 Đang fetch dữ liệu mực nước hồ...
📡 Making API call to: https://hodautieng.vn/jaxrs/QuanTracHoChua/getDataQuanTracTB (Attempt 1/3)
📋 Request payload: {
  "data": {
    "hc_uuid": "613bbcf5-212e-43c5-9ef8-69016787454f",
    "tents": "Mực nước hồ",
    "mats": "MUCNUOCHO",
    "tungay": "2025-8-18 3:42:21",
    "denngay": "2025-8-21 3:42:21",
    "namdulieu": "2025",
    "namht": 2025,
    "mact": "613bbcf5-212e-43c5-9ef8-69016787454f"
  }
}
📋 Đã tải 3 trạm từ database: [
  '4B413AEE-357A-4FFE-9AE8-591FCA84468C',
  '4EC7BBAF-44E7-4DFA-BAED-4FB1217FBDA8',
  'C6B0DB30-500A-4BF9-AA09-B2470E85BF45'
]
🕐 Bắt đầu lịch trình gọi API thủy triều thực tế...
⏰ Thời gian: 03:42:21 21/8/2025
🔥 Force mode: true
📡 Đang gọi API cho trạm: 4B413AEE-357A-4FFE-9AE8-591FCA84468C (force=true)
🔄 Force refresh cho trạm: 4B413AEE-357A-4FFE-9AE8-591FCA84468C
📡 Gọi API (lần 1): http://e15.thuyloivietnam.vn/wsHienTrangHoChua/ChartRiverMucNuoc?stationcode=4B413AEE-357A-4FFE-9AE8-591FCA84468C
✅ API response status: 200
📊 API trả về 15 records
🔄 Chuyển đổi: 0.88m → 88cm
🔄 Chuyển đổi: 0.88m → 88cm
🔄 Chuyển đổi: 0.88m → 88cm
🔄 Chuyển đổi: 0.88m → 88cm
🔄 Chuyển đổi: 0.88m → 88cm
🔄 Chuyển đổi: 0.54m → 54cm
🔄 Chuyển đổi: 0.54m → 54cm
🔄 Chuyển đổi: 0.54m → 54cm
🔄 Chuyển đổi: 0.54m → 54cm
🔄 Chuyển đổi: 0.54m → 54cm
🔄 Chuyển đổi: 0.62m → 62cm
🔄 Chuyển đổi: 0.62m → 62cm
🔄 Chuyển đổi: 1.04m → 104cm
🔄 Chuyển đổi: 1.08m → 108cm
🔄 Chuyển đổi: 0.34m → 34cm
📊 Sau khi lọc trùng lặp: 6 records
📊 Processed 6 tide realy records from 6 raw records
📊 Processed data ready for database: 6 records (6 total)
🔄 Starting SAFE station-specific data replacement for station: 4B413AEE-357A-4FFE-9AE8-591FCA84468C
📊 Input data count: 6
📊 Model name: TideRealy
🗑️ Deleting existing data for station: 4B413AEE-357A-4FFE-9AE8-591FCA84468C
🗑️ Successfully deleted 6 documents
🗑️ Deleted old data for station 4B413AEE-357A-4FFE-9AE8-591FCA84468C: 6 records
💾 Inserting new data for station: 4B413AEE-357A-4FFE-9AE8-591FCA84468C
💾 Successfully inserted 6 documents
💾 Inserted new data for station 4B413AEE-357A-4FFE-9AE8-591FCA84468C: 6 records
📊 Verifying insertion for station: 4B413AEE-357A-4FFE-9AE8-591FCA84468C
📊 Found 6 documents matching filter
📊 Final document count for station 4B413AEE-357A-4FFE-9AE8-591FCA84468C: 6
✅ Station-specific data replacement successful for station: 4B413AEE-357A-4FFE-9AE8-591FCA84468C
✅ Đã force refresh và thay thế toàn bộ dữ liệu cho trạm: 4B413AEE-357A-4FFE-9AE8-591FCA84468C
✅ Trạm 4B413AEE-357A-4FFE-9AE8-591FCA84468C: 6 records mới, 6 records tổng
📡 Đang gọi API cho trạm: 4EC7BBAF-44E7-4DFA-BAED-4FB1217FBDA8 (force=true)
🔄 Force refresh cho trạm: 4EC7BBAF-44E7-4DFA-BAED-4FB1217FBDA8
📡 Gọi API (lần 1): http://e15.thuyloivietnam.vn/wsHienTrangHoChua/ChartRiverMucNuoc?stationcode=4EC7BBAF-44E7-4DFA-BAED-4FB1217FBDA8
✅ API response status: 200
📊 API trả về 15 records
🔄 Chuyển đổi: 2.83m → 283cm
🔄 Chuyển đổi: 3.29m → 329cm
🔄 Chuyển đổi: 3.29m → 329cm
🔄 Chuyển đổi: 3.29m → 329cm
🔄 Chuyển đổi: 3.29m → 329cm
🔄 Chuyển đổi: 3.29m → 329cm
🔄 Chuyển đổi: 3.51m → 351cm
🔄 Chuyển đổi: 3.51m → 351cm
🔄 Chuyển đổi: 3.51m → 351cm
🔄 Chuyển đổi: 3.51m → 351cm
🔄 Chuyển đổi: 3.51m → 351cm
🔄 Chuyển đổi: 3.51m → 351cm
🔄 Chuyển đổi: 3.53m → 353cm
🔄 Chuyển đổi: 3.3m → 330cm
🔄 Chuyển đổi: 3.32m → 332cm
📊 Sau khi lọc trùng lặp: 6 records
🔧 Điều chỉnh giá trị Vũng Tàu: 283 -> -5.5 (trừ 288.5)
🔧 Điều chỉnh giá trị Vũng Tàu: 329 -> 40.5 (trừ 288.5)
🔧 Điều chỉnh giá trị Vũng Tàu: 351 -> 62.5 (trừ 288.5)
🔧 Điều chỉnh giá trị Vũng Tàu: 353 -> 64.5 (trừ 288.5)
🔧 Điều chỉnh giá trị Vũng Tàu: 330 -> 41.5 (trừ 288.5)
🔧 Điều chỉnh giá trị Vũng Tàu: 332 -> 43.5 (trừ 288.5)
📊 Processed 6 tide realy records from 6 raw records
📊 Processed data ready for database: 6 records (6 total)
🔄 Starting SAFE station-specific data replacement for station: 4EC7BBAF-44E7-4DFA-BAED-4FB1217FBDA8
📊 Input data count: 6
📊 Model name: TideRealy
🗑️ Deleting existing data for station: 4EC7BBAF-44E7-4DFA-BAED-4FB1217FBDA8
🗑️ Successfully deleted 6 documents
🗑️ Deleted old data for station 4EC7BBAF-44E7-4DFA-BAED-4FB1217FBDA8: 6 records
💾 Inserting new data for station: 4EC7BBAF-44E7-4DFA-BAED-4FB1217FBDA8
💾 Successfully inserted 6 documents
💾 Inserted new data for station 4EC7BBAF-44E7-4DFA-BAED-4FB1217FBDA8: 6 records
📊 Verifying insertion for station: 4EC7BBAF-44E7-4DFA-BAED-4FB1217FBDA8
📊 Found 6 documents matching filter
📊 Final document count for station 4EC7BBAF-44E7-4DFA-BAED-4FB1217FBDA8: 6
✅ Station-specific data replacement successful for station: 4EC7BBAF-44E7-4DFA-BAED-4FB1217FBDA8
✅ Đã force refresh và thay thế toàn bộ dữ liệu cho trạm: 4EC7BBAF-44E7-4DFA-BAED-4FB1217FBDA8
✅ Trạm 4EC7BBAF-44E7-4DFA-BAED-4FB1217FBDA8: 6 records mới, 6 records tổng
📡 Đang gọi API cho trạm: C6B0DB30-500A-4BF9-AA09-B2470E85BF45 (force=true)
🔄 Force refresh cho trạm: C6B0DB30-500A-4BF9-AA09-B2470E85BF45
📡 Gọi API (lần 1): http://e15.thuyloivietnam.vn/wsHienTrangHoChua/ChartRiverMucNuoc?stationcode=C6B0DB30-500A-4BF9-AA09-B2470E85BF45
✅ API response status: 200
📊 API trả về 15 records
🔄 Chuyển đổi: 1.12m → 112.00000000000001cm
🔄 Chuyển đổi: 1.12m → 112.00000000000001cm
🔄 Chuyển đổi: 1.12m → 112.00000000000001cm
🔄 Chuyển đổi: 1.12m → 112.00000000000001cm
🔄 Chuyển đổi: 1.12m → 112.00000000000001cm
🔄 Chuyển đổi: 1.24m → 124cm
🔄 Chuyển đổi: 1.24m → 124cm
🔄 Chuyển đổi: 1.24m → 124cm
🔄 Chuyển đổi: 1.24m → 124cm
🔄 Chuyển đổi: 1.24m → 124cm
🔄 Chuyển đổi: 0.52m → 52cm
🔄 Chuyển đổi: 0.52m → 52cm
🔄 Chuyển đổi: 0.63m → 63cm
🔄 Chuyển đổi: 1.4m → 140cm
🔄 Chuyển đổi: 0.78m → 78cm
📊 Sau khi lọc trùng lặp: 6 records
📊 Processed 6 tide realy records from 6 raw records
📊 Processed data ready for database: 6 records (6 total)
🔄 Starting SAFE station-specific data replacement for station: C6B0DB30-500A-4BF9-AA09-B2470E85BF45
📊 Input data count: 6
📊 Model name: TideRealy
🗑️ Deleting existing data for station: C6B0DB30-500A-4BF9-AA09-B2470E85BF45
✅ API call successful on attempt 1
📊 Processed 52 records from 52 raw records
⚠️ WARNING: replaceAllData is deprecated and DANGEROUS - it deletes ALL data in collection!
⚠️ Use replaceStationData for station-specific replacement instead.
🔄 Starting complete data replacement...
🗑️ Successfully deleted 6 documents
🗑️ Deleted old data for station C6B0DB30-500A-4BF9-AA09-B2470E85BF45: 6 records
💾 Inserting new data for station: C6B0DB30-500A-4BF9-AA09-B2470E85BF45
🗑️ Successfully deleted 52 documents
🗑️ Deleted old data: 52 records
💾 Successfully inserted 6 documents
💾 Inserted new data for station C6B0DB30-500A-4BF9-AA09-B2470E85BF45: 6 records
📊 Verifying insertion for station: C6B0DB30-500A-4BF9-AA09-B2470E85BF45
💾 Successfully inserted 52 documents
💾 Inserted new data: 52 records
✅ Complete data replacement successful!
✅ Mực nước hồ: 52 records mới
💧 Đang fetch dữ liệu lưu lượng nước...
📡 Making API call to: https://hodautieng.vn/jaxrs/QuanTracHoChua/getDataQuanTracTB (Attempt 1/3)
📋 Request payload: {
  "data": {
    "hc_uuid": "613bbcf5-212e-43c5-9ef8-69016787454f",
    "tents": "Dòng chảy đến hồ",
    "mats": "QDEN",
    "tungay": "2025-8-18 3:42:21",
    "denngay": "2025-8-21 3:42:21",
    "namdulieu": "2025",
    "namht": 2025,
    "mact": "613bbcf5-212e-43c5-9ef8-69016787454f"
  }
}
📊 Found 6 documents matching filter
📊 Final document count for station C6B0DB30-500A-4BF9-AA09-B2470E85BF45: 6
✅ Station-specific data replacement successful for station: C6B0DB30-500A-4BF9-AA09-B2470E85BF45
✅ Đã force refresh và thay thế toàn bộ dữ liệu cho trạm: C6B0DB30-500A-4BF9-AA09-B2470E85BF45
✅ Trạm C6B0DB30-500A-4BF9-AA09-B2470E85BF45: 6 records mới, 6 records tổng
📊 Tóm tắt kết quả:
  ✅ 4B413AEE-357A-4FFE-9AE8-591FCA84468C: 6 records mới (6)
  ✅ 4EC7BBAF-44E7-4DFA-BAED-4FB1217FBDA8: 6 records mới (6)
  ✅ C6B0DB30-500A-4BF9-AA09-B2470E85BF45: 6 records mới (6)
✅ API call successful on attempt 1
📊 Processed 68 Qden records from 68 raw records
⚠️ WARNING: replaceAllData is deprecated and DANGEROUS - it deletes ALL data in collection!
⚠️ Use replaceStationData for station-specific replacement instead.
🔄 Starting complete data replacement...
🗑️ Successfully deleted 68 documents
🗑️ Deleted old data: 68 records
💾 Successfully inserted 68 documents
💾 Inserted new data: 68 records
✅ Complete data replacement successful!
✅ Lưu lượng nước: 68 records mới
🚰 Đang fetch dữ liệu lưu lượng xả...
📡 Making API call to: https://hodautieng.vn/jaxrs/QuanTracHoChua/getDataQuanTrac (Attempt 1/3)
📋 Request payload: {
  "data": {
    "hc_uuid": "613bbcf5-212e-43c5-9ef8-69016787454f",
    "tents": "Tổng lưu lượng ra khỏi hồ",
    "mats": "LUULUONGXA",
    "mact": "",
    "tungay": "2025-8-18 3:42:21",
    "denngay": "2025-8-21 3:42:21",
    "denngaydb": "2025-8-24 3:42:21",
    "ngayht": "2025-8-21 3:42:21",
    "nguondb": "2",
    "gioht": "00,01,02,03,04,05,06,07,08,09,10,11,12,13,14,15,16,17,18,19,20,21,22,23",
    "tansuat": 60
  },
  "token": ""
}
✅ API call successful on attempt 1
🔍 Luuluongxa processing item 0: {
  original: {
    data_thoigian: '2025-08-18 04:42:21',
    data_thoigian_hienthi: '18/08/2025 04:42:21',
    luuluongxa: 61.659004,
    luuluongcong: 41.375015,
    luuluongtran: 20.283989,
    luuluongthuydien: null
  },
  processed: {
    data_thoigian: 2025-08-17T21:42:21.000Z,
    data_thoigian_hienthi: '18/08/2025 04:42:21',
    luuluongxa: 61.659004,
    luuluongcong: 41.375015,
    luuluongtran: 20.283989,
    luuluongthuydien: null,
    unit: 'm³/s'
  }
}
🔍 Luuluongxa processing item 1: {
  original: {
    data_thoigian: '2025-08-18 05:42:21',
    data_thoigian_hienthi: '18/08/2025 05:42:21',
    luuluongxa: 61.659004,
    luuluongcong: 41.375015,
    luuluongtran: 20.283989,
    luuluongthuydien: null
  },
  processed: {
    data_thoigian: 2025-08-17T22:42:21.000Z,
    data_thoigian_hienthi: '18/08/2025 05:42:21',
    luuluongxa: 61.659004,
    luuluongcong: 41.375015,
    luuluongtran: 20.283989,
    luuluongthuydien: null,
    unit: 'm³/s'
  }
}
📊 Processed 69 Luuluongxa records from 69 raw records
⚠️ WARNING: replaceAllData is deprecated and DANGEROUS - it deletes ALL data in collection!
⚠️ Use replaceStationData for station-specific replacement instead.
🔄 Starting complete data replacement...
🗑️ Successfully deleted 69 documents
🗑️ Deleted old data: 69 records
💾 Successfully inserted 69 documents
💾 Inserted new data: 69 records
✅ Complete data replacement successful!
✅ Lưu lượng xả: 69 records mới
📊 Tóm tắt kết quả fetch Hồ Dầu Tiếng:
  ✅ mucnuocho: 52 records mới
  ✅ qden: 68 records mới
  ✅ luuluongxa: 69 records mới
🎯 Tổng kết: 3/3 thành công, 189 records mới
🎬 Fetch dữ liệu Mekong lần đầu...
🌊 Bắt đầu fetch dữ liệu Mekong theo lịch trình...
⏰ Thời gian: 03:42:26 21/8/2025
🌊 Bắt đầu fetch dữ liệu từ tất cả Mekong stations...
📡 Fetching data for ChauDoc...
🌊 Bắt đầu fetch dữ liệu Mekong API cho ChauDoc (CDO)...
📡 Calling Mekong API... (Attempt 1/3)
🔗 API URL: https://ffw.mrcmekong.org/fetch_stforecast.php?StCode=CDO
⏳ Initial fetch for Binh Duong data after 15 seconds...
Đã cập nhật 6 trạm với lịch sử
✅ Initial fetch completed
✅ Mekong API call successful on attempt 1
📋 Response status: 200
📡 Received 896 chars from ChauDoc API
🔄 Parsing Mekong array string...
✅ Successfully parsed 12 items from Mekong API
📊 API trả về 12 records cho ChauDoc
🔄 Processing Mekong data for station: ChauDoc (CDO)
✅ Processed 12 valid items for ChauDoc out of 12 total
✅ Validation passed for 12 items
🔄 Starting SAFE station-specific data replacement for station: CDO
📊 Input data count: 12
📊 Model name: Mekong
🗑️ Deleting existing data for station: CDO
🗑️ Successfully deleted 12 documents
🗑️ Deleted old data for station CDO: 12 records
💾 Inserting new data for station: CDO
💾 Successfully inserted 12 documents
💾 Inserted new data for station CDO: 12 records
📊 Verifying insertion for station: CDO
📊 Found 12 documents matching filter
📊 Final document count for station CDO: 12
✅ Station-specific data replacement successful for station: CDO
⚠️ Could not calculate date range for ChauDoc: Invalid time value
📡 Fetching data for TanChau...
🌊 Bắt đầu fetch dữ liệu Mekong API cho TanChau (TCH)...
📡 Calling Mekong API... (Attempt 1/3)
🔗 API URL: https://ffw.mrcmekong.org./fetch_stforecast.php?StCode=TCH
✅ Mekong API call successful on attempt 1
📋 Response status: 200
📡 Received 943 chars from TanChau API
🔄 Parsing Mekong array string...
✅ Successfully parsed 12 items from Mekong API
📊 API trả về 12 records cho TanChau
🔄 Processing Mekong data for station: TanChau (TCH)
✅ Processed 12 valid items for TanChau out of 12 total
✅ Validation passed for 12 items
🔄 Starting SAFE station-specific data replacement for station: TCH
📊 Input data count: 12
📊 Model name: Mekong
🗑️ Deleting existing data for station: TCH
🗑️ Successfully deleted 12 documents
🗑️ Deleted old data for station TCH: 12 records
💾 Inserting new data for station: TCH
💾 Successfully inserted 12 documents
💾 Inserted new data for station TCH: 12 records
📊 Verifying insertion for station: TCH
📊 Found 12 documents matching filter
📊 Final document count for station TCH: 12
✅ Station-specific data replacement successful for station: TCH
⚠️ Could not calculate date range for TanChau: Invalid time value
✅ Mekong scheduler: undefined records được lưu thành công
📊 Kết quả: undefined/undefined stations thành công
Đã cập nhật 6 trạm với lịch sử
Request params: { key: 'BD_TD01_NUOTDM', start: '2025-08-20', end: '2025-08-21' }
Debug - First history entry: {
  "timestamp": "2025-08-20T20:44:00.000Z",
  "measuringLogs": {
    "COD": {
      "key": "COD",
      "name": "COD",
      "unit": "mg/L",
      "maxLimit": 10,
      "minLimit": null,
      "maxTend": null,
      "minTend": null,
      "maxRange": null,
      "minRange": null,
      "value": 20.2,
      "statusDevice": 0,
      "warningLevel": "EXCEEDED"
    },
    "EC": {
      "key": "EC",
      "name": "EC",
      "unit": "uS/cm",
      "maxLimit": null,
      "minLimit": null,
      "maxTend": null,
      "minTend": null,
      "maxRange": null,
      "minRange": null,
      "value": 171.8,
      "statusDevice": 0,
      "warningLevel": "GOOD"
    },
    "DO": {
      "key": "DO",
      "name": "DO",
      "unit": "mg/l",
      "maxLimit": 20,
      "minLimit": 0,
      "maxTend": null,
      "minTend": null,
      "maxRange": null,
      "minRange": null,
      "value": 0.6,
      "statusDevice": 0,
      "warningLevel": "GOOD"
    },
    "Temp": {
      "key": "Temp",
      "name": "Temp",
      "unit": "oC",
      "maxLimit": 109,
      "minLimit": null,
      "maxTend": null,
      "minTend": null,
      "maxRange": null,
      "minRange": null,
      "value": 29.6,
      "statusDevice": 0,
      "warningLevel": "GOOD"
    },
    "pH": {
      "key": "pH",
      "name": "pH",
      "unit": "",
      "maxLimit": 8.5,
      "minLimit": 5.5,
      "maxTend": null,
      "minTend": null,
      "maxRange": null,
      "minRange": null,
      "value": 6.6,
      "statusDevice": 0,
      "warningLevel": "GOOD"
    },
    "TSS": {
      "key": "TSS",
      "name": "TSS",
      "unit": "mg/l",
      "maxLimit": 25,
      "minLimit": null,
      "maxTend": null,
      "minTend": null,
      "maxRange": null,
      "minRange": null,
      "value": 43.8,
      "statusDevice": 0,
      "warningLevel": "EXCEEDED"
    }
  },
  "_id": "68a6330a907dc65495dc54f4"
}
Debug - Processing entry: {
  timestamp: 2025-08-20T20:44:00.000Z,
  hasMeasuringLogs: true,
  measuringLogsType: 'object',
  measuringLogsKeys: [ 'COD', 'EC', 'DO', 'Temp', 'pH', 'TSS' ]
}
Debug - Processing entry: {
  timestamp: 2025-08-20T20:44:00.000Z,
  hasMeasuringLogs: true,
  measuringLogsType: 'object',
  measuringLogsKeys: [ 'COD', 'EC', 'DO', 'Temp', 'pH', 'TSS' ]
}
Debug - Processing entry: {
  timestamp: 2025-08-20T20:44:00.000Z,
  hasMeasuringLogs: true,
  measuringLogsType: 'object',
  measuringLogsKeys: [ 'COD', 'EC', 'DO', 'Temp', 'pH', 'TSS' ]
}
Tri An data scraped and saved
[32m[nodemon] restarting due to changes...[39m
[32m[nodemon] starting `node src/server.js`[39m
(node:3604) [MONGOOSE] Warning: Duplicate schema index on {"data_thoigian":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(Use `node --trace-warnings ...` to show where the warning was created)
(node:3604) [MONGOOSE] Warning: Duplicate schema index on {"data_thoigian":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:3604) [MONGOOSE] Warning: Duplicate schema index on {"data_thoigian":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
node:events:496
      throw er; // Unhandled 'error' event
      ^

Error: listen EADDRINUSE: address already in use :::1423
    at Server.setupListenHandle [as _listen2] (node:net:1939:16)
    at listenInCluster (node:net:1996:12)
    at Server.listen (node:net:2101:7)
    at Function.listen (C:\project-hydrology-dashboard\backend\node_modules\express\lib\application.js:635:24)
    at Object.<anonymous> (C:\project-hydrology-dashboard\backend\src\server.js:95:20)
    at Module._compile (node:internal/modules/cjs/loader:1730:14)
    at Object..js (node:internal/modules/cjs/loader:1895:10)
    at Module.load (node:internal/modules/cjs/loader:1465:32)
    at Function._load (node:internal/modules/cjs/loader:1282:12)
    at TracingChannel.traceSync (node:diagnostics_channel:322:14)
Emitted 'error' event on Server instance at:
    at emitErrorNT (node:net:1975:8)
    at process.processTicksAndRejections (node:internal/process/task_queues:90:21) {
  code: 'EADDRINUSE',
  errno: -4091,
  syscall: 'listen',
  address: '::',
  port: 1423
}

Node.js v22.15.0
[31m[nodemon] app crashed - waiting for file changes before starting...[39m
